<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>마이페이지</title>
        <link rel="stylesheet" href="mypage.css" />
        <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    </head>

    <body>
        <header>
            <div id="logo" onclick="to_main()">
                <img src="./image/asopi_logo.png" alt="로고" width="50%" />
            </div>
        </header>

        <div id="head-container">
            <div class="profile">
                <h2 id="title">안녕하세요 <span id="username"></span>님</h2>
                <h3 id="email"></h3>
            </div>
            <div id="logout">
                <button id="logout_button" onclick="clearLocalStorage()">로그아웃</button>
            </div>
        </div>

        <div class="button-container"></div>
        <div class="container">
            <div class="btn-box" style="text-align: left">
                <h2 id="title2" style="display: inline-block">진단 내역 보기</h2>
                <button id="btn-close-all" style="display: inline-block">모두 닫기</button>
            </div>
            <table>
                <thead></thead>
                <tbody id="diagnosisRecords">
                    <!-- 진단 기록이 여기에 동적으로 추가됩니다 -->
                </tbody>
            </table>
        </div>
        <div class="button-container">
            <div id="hospital-button" onclick="navigateToMap()">
                내 주변 병원 보러 가기 &nbsp;&nbsp;&nbsp;
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                〉
            </div>
            <div id="story-button" onclick="openModal()">
                우리 아이가 쓰는 연고 괜찮을까?
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                〉
            </div>
        </div>

        <!-- 모달 -->
        <div id="myModal" class="modal">
            <div class="modal-content">
                <!-- 모달 내용 -->
                <div id="modal_title">
                    <p id="close" onclick="closeModal()">&times;</p>
                    <p id="modal-text">어떤 연고가 궁금하신가요?</p>
                </div>
                <button id="no1" onclick="handleButtonClick(1)">상처에 바르는 연고(후시딘)</button>
                <button id="no2" onclick="handleButtonClick(2)">가려움증에 바르는 연고</button>
                <button id="no3" onclick="handleButtonClick(3)">곰팜이성 피부 질환에 바르는 연고</button>
                <button id="no4" onclick="handleButtonClick(4)">단순 포진에 바르는 연고</button>
            </div>
        </div>

        <script>
            const backendUrl = 'http://localhost:3001';
            const userEmail = localStorage.userEmail;
            const mypageEndpoint = `/mypage/${userEmail}`;

            const mypageUrl = backendUrl + mypageEndpoint;

            window.onload = async function () {
                try {
                    if (!localStorage.userToken) {
                        alert('로그인이 필요합니다.'); // 경고 메시지 표시
                        to_main();
                        return;
                    }
                    const userData = await fetchUserData();
                    document.getElementById('username').textContent = localStorage.userName;
                    document.getElementById('email').textContent = localStorage.userEmail;

                    // 사용자 정보가 있는 경우 페이지에 반영
                    if (userData) {
                        // 진료 기록을 화면에 표시
                        await displayDiagnosisRecords(
                            userData.userRecords,
                            userData.recordDates,
                            userData.childName,
                            userData.childAge
                        );
                    } else {
                        console.log('사용자 정보를 가져올 수 없습니다.');
                    }
                } catch (error) {
                    console.error('사용자 데이터를 불러오는 중 오류가 발생했습니다:', error);
                }
            };

            //로그아웃
            function clearLocalStorage() {
                localStorage.clear(); // 로컬 스토리지를 비움
                window.location.href = 'http://localhost:3000/'; //메인 페이지로 이동하도록 설정
            }

            // 사용자 정보를 가져오는 함수
            async function fetchUserData(userEmail) {
                try {
                    const response = await axios.get(`${mypageUrl}?userEmail=${userEmail}`);
                    const userData = response.data;

                    // record와 recordDate를 따로 추출
                    const userRecords = userData.data.record.map((record) => JSON.parse(record));
                    console.log('기록 : ', userRecords);
                    const recordDates = userData.data.recordDate;
                    console.log('진료 시각 : ', recordDates);
                    const childName = userData.data.childName;
                    console.log('애 이름 : ', childName);
                    const childAge = userData.data.childAge;
                    console.log('애 나이 : ', childAge);

                    return { userRecords, recordDates, childName, childAge };
                } catch (error) {
                    console.error('Error fetching user info:', error);
                    return null;
                }
            }
// 진료 내역을 화면에 표시하는 함수
function displayDiagnosisRecords(userRecords, recordDates, childName, childAge) {
    // 진단 기록 동적 생성
    const diagnosisRecords = document.getElementById('diagnosisRecords');

    console.log('userRecords:', userRecords);
    console.log('recordDates:', recordDates);

    // 모두 닫기 버튼 클릭 이벤트 처리
    document.getElementById('btn-close-all').addEventListener('click', function() {
        const allContents = document.querySelectorAll('.full-content');
        allContents.forEach(content => {
            content.style.display = 'none';
        });
    });

    if (userRecords && userRecords.length > 0) {
        userRecords.forEach((record, index) => {
            const tr = document.createElement('tr');
            const accordionContent = document.createElement('div');
            accordionContent.className = 'accordion-content'; // 아코디언 내용에 클래스 추가

            tr.innerHTML = `
                <td>></td>
                <td>
                    <div class="accordion-container">
                        <div class="record_title">
                            <h3 class="accordion-title">진단기록${index + 1}</h3>
                            <h3 class="childName"> ${childName[index]}</h3>
                            <h3 class="childAge"> ${childAge[index]} </h3>
                        </div>
                        <div class="full-content" style="display: none;">
                            <p class="disease">질병: ${record.disease.replace(/\\n|""/g, '')}</p>
                            <p class="symptom">증상: ${record.symptom.replace(/\\n|""/g, '')}</p>
                            <p class="description">설명: ${record.description.replace(/\\n|""/g, '')}</p>
                        </div>
                    </div>
                </td>
            `;

            tr.querySelector('.accordion-title').addEventListener('click', function() {
                const fullContent = tr.querySelector('.full-content');
                const isHidden = fullContent.style.display === 'none';

                // 모든 내용을 닫음
                document.querySelectorAll('.full-content').forEach(content => {
                    content.style.display = 'none';
                });

                // 클릭한 진단 기록의 내용만 펼침
                fullContent.style.display = isHidden ? 'block' : 'none';
            });

            diagnosisRecords.appendChild(tr);
        });
    } else {
        console.log('No diagnosis records available.');
        // TODO: 진단 기록이 없을 때의 처리를 추가하세요.
    }
}





            //진단 기록에서 날짜만 추출
            function formatDate(dateString) {
                const options = { year: 'numeric', month: '2-digit', day: '2-digit' };
                const formattedDate = new Date(dateString).toISOString().split('T')[0];
                return formattedDate;
            }

            function navigateToMap() {
                // Redirect to map.html
                window.location.href = 'map.html';
            }

            // 모달 열기
            function openModal() {
                document.getElementById('myModal').style.display = 'block';
            }

            // 모달 닫기
            function closeModal() {
                document.getElementById('myModal').style.display = 'none';
            }

            // 모달 외부 클릭 시 닫기
            window.onclick = function (event) {
                var modal = document.getElementById('myModal');
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            };

            function handleButtonClick(buttonNumber) {
                var targetPageUrl = 'contents.html'; // 이동할 페이지의 URL
                var targetElementId;

                switch (buttonNumber) {
                    case 1:
                        targetElementId = '#head1'; // 이동할 요소의 ID
                        break;
                    case 2:
                        targetElementId = '#head2'; // 이동할 요소의 ID
                        break;
                    case 3:
                        targetElementId = '#head3'; // 이동할 요소의 ID
                        break;
                    case 4:
                        targetElementId = '#head4'; // 이동할 요소의 ID
                        break;
                    default:
                        // 기본 처리
                        break;
                }

                // 새로운 페이지로 이동
                window.location.href = targetPageUrl + targetElementId;
            }

            function checkTokenAndRedirect() {
                // 로컬 스토리지에서 토큰을 가져옵니다.
                const userToken = localStorage.getItem('userToken');

                // 토큰이 없는 경우 경고 메시지를 표시하고 메인 페이지로 이동합니다.
                if (!userToken) {
                    alert('로그인이 필요합니다.'); // 경고 메시지 표시
                    window.location.href = 'http://localhost:3000/'; // 메인 페이지로 이동
                }
            }

            /*function sendTokenAndEmailToBackend() {
                // 사용자의 토큰과 이메일을 로컬 스토리지에서 가져오기
                const userToken = localStorage.getItem('userToken');
                const userEmail = '사용자의 이메일 가져오는 방법'; // 사용자의 이메일을 가져오는 방법을 추가해야 합니다.

                // Ajax를 사용하여 서버에 토큰과 이메일을 전송
                $.ajax({
                    type: 'POST',
                    url: '토큰과이메일을보내는엔드포인트', // 실제 서버 URL로 대체 필요
                    data: { token: userToken, email: userEmail },
                    success: function (response) {
                        console.log('서버 응답:', response);
                        // 서버 응답에 따라 추가적인 작업 수행 가능
                    },
                    error: function (error) {
                        console.error('오류 발생:', error);
                    },
                });
            }*/

            /* window.onload = function () {
                checkTokenAndRedirect(); // 페이지가 로드되면 바로 실행될 함수 호출
            };

            function checkTokenAndRedirect() {
                // 로컬 스토리지에서 토큰을 가져옵니다.
                const userToken = localStorage.getItem('userToken');

                // 토큰이 없는 경우 경고 메시지를 표시하고 메인 페이지로 이동합니다.
                if (!userToken) {
                    alert('로그인이 필요합니다.'); // 경고 메시지 표시
                    window.location.href = 'http://localhost:3000/'; // 메인 페이지로 이동
                }
            }  */

            function to_main() {
                window.location.href = 'http://localhost:3000/';
            }
        </script>
    </body>
</html>